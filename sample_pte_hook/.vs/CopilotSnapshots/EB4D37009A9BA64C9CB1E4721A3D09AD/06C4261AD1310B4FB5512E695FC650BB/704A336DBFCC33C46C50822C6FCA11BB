#pragma once

#include <ntifs.h>
#include <ntddk.h>
#include <stdint.h>

// Basic page size
#ifndef PAGE_SIZE
#define PAGE_SIZE 0x1000
#endif

// 64-bit PTE formats (simplified)
typedef union _pte_64 {
    uint64_t value;
    struct {
        uint64_t present : 1;
        uint64_t writable : 1;
        uint64_t user_accessible : 1;
        uint64_t write_through : 1;
        uint64_t cache_disable : 1;
        uint64_t accessed : 1;
        uint64_t dirty : 1;
        uint64_t pat : 1;
        uint64_t global : 1;
        uint64_t ignored1 : 3;
        uint64_t page_frame_number : 40;
        uint64_t reserved : 11;
        uint64_t nx : 1;
    };
} pte_64, *ppte_64;

typedef union _pde_64 {
    uint64_t value;
    struct {
        uint64_t present : 1;
        uint64_t writable : 1;
        uint64_t user_accessible : 1;
        uint64_t write_through : 1;
        uint64_t cache_disable : 1;
        uint64_t accessed : 1;
        uint64_t dirty : 1;
        uint64_t pat : 1;
        uint64_t large_page : 1;
        uint64_t ignored1 : 3;
        uint64_t page_frame_number : 40;
        uint64_t reserved : 11;
        uint64_t nx : 1;
    };
} pde_64, *ppde_64;

typedef union _pdpte_64 {
    uint64_t value;
    struct {
        uint64_t present : 1;
        uint64_t writable : 1;
        uint64_t user_accessible : 1;
        uint64_t write_through : 1;
        uint64_t cache_disable : 1;
        uint64_t accessed : 1;
        uint64_t reserved1 : 1;
        uint64_t reserved2 : 1;
        uint64_t ignored1 : 4;
        uint64_t page_frame_number : 40;
        uint64_t reserved : 11;
        uint64_t nx : 1;
    };
} pdpte_64, *ppdpte_64;

typedef union _pml4e_64 {
    uint64_t value;
    struct {
        uint64_t present : 1;
        uint64_t writable : 1;
        uint64_t user_accessible : 1;
        uint64_t write_through : 1;
        uint64_t cache_disable : 1;
        uint64_t accessed : 1;
        uint64_t reserved1 : 1;
        uint64_t reserved2 : 1;
        uint64_t ignored1 : 4;
        uint64_t page_frame_number : 40;
        uint64_t reserved : 11;
        uint64_t nx : 1;
    };
} pml4e_64, *ppml4e_64;

// CR3 representation (simplified)
typedef union _cr3 {
    uint64_t flags;
    struct {
        uint64_t reserved1 : 3;
        uint64_t write_protect : 1;
        uint64_t reserved2 : 7;
        uint64_t address_of_page_directory : 40;
        uint64_t reserved3 : 13;
    };
} cr3;

// Provide an accessor to read CR3
static inline cr3 read_cr3() {
    cr3 r = { 0 };
    r.flags = __readcr3();
    return r;
}
